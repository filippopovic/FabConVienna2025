<img src = "../assets/images/microsoft-logo.png" height = 75/>

# End-to-End Data Engineering:<br>Modern Data Warehousing on Microsoft Fabric

## Lab 6 - Data warehouse management

Before you begin:

- Make sure you have read the overview on the [workshop homepage](<../README.md>).
- If you have not completed [Lab 5 - Orchestrating warehouse operations](<05 - Orchestrating warehouse operations.md>), go complete all the steps then return here to continue.

This lab will cover:

- <a href="#6.1">Checking important warehouse settings</a>
- <a href="#6.2">Statistics management</a>
- <a href="#6.3">Query monitoring</a>

<hr>

**Before starting**, make sure that you have WarehouseManagement notebook open and connected to WWI_Gold warehouse. If not, refer to **Lab 1 - Getting started**, locate the **1.3 - T-SQL notebooks** to load and open WarehouseManagement notebook, and connect it to WWI_Gold warehouse.

<h3 id = "6.1">6.1 - Checking important warehouse settings</h3>

Before beginning, open *WarehouseManagement* notebook, and navigate to the **6.1 - Checking important warehouse settings** section.

1. To see the current setting for the items listed below, run the cell for **Step 6.1.1** in *WarehouseManagement* notebook. Upon completion, the cell will a set of query results will be displayed. :

    - Collation
    - Case sensitivity
    - Snapshot isolation
    - Statistics auto create
    - Statistics auto update
    - Delta log publishing
    - V-Order

    ``` sql
    SELECT
        name,
        collation_name,
        CASE collation_name
            WHEN 'Latin1_General_100_BIN2_UTF8'           THEN 1
            WHEN 'Latin1_General_100_CI_AS_KS_WS_SC_UTF8' THEN 0
            ELSE NULL
            END AS is_case_sensitive,
        snapshot_isolation_state_desc,
        is_auto_create_stats_on,
        is_auto_update_stats_on,
        data_lake_log_publishing_desc,
        CASE data_lake_log_publishing_desc
            WHEN 'AUTO' THEN 1
            WHEN 'PAUSED' THEN 0
            ELSE NULL
            END AS is_delta_lake_log_publishing_on,
        is_vorder_enabled,
        is_result_set_caching_on
    FROM sys.databases
    WHERE name = DB_NAME()
    ```

    <img src = "../assets/images/07_warehouse_settings.png"/>

<h3 id = "6.2">6.2 - Statistics management</h3>

Before beginning, open *WarehouseManagement* notebook, navigate to **Lab 6 - Data warehouse management**, and locate the **6.2 - Statistics management** section.

1. You can see the types of statistics which have already been generated by the system by running the cell for **Step 6.2.1** in *WarehouseManagement* notebook and exploring the results.

    ``` sql
    SELECT
        schema_name(o.schema_id) AS schema_name,
        object_name(s.object_id) AS [object_name],
        c.name AS [column_name],
        s.name AS [stats_name],
        STATS_DATE(s.object_id, s.stats_id) AS [stats_update_date], 
        CASE
            WHEN s.auto_created = 1 THEN 'System'
            WHEN s.user_created = 1 THEN 'User'
            ELSE NULL END AS stats_created_by
    FROM sys.stats AS s 
    INNER JOIN sys.objects AS o 
        ON o.object_id = s.object_id 
    LEFT JOIN sys.stats_columns AS sc 
        ON s.object_id = sc.object_id 
        AND s.stats_id = sc.stats_id 
    LEFT JOIN sys.columns AS c 
        ON sc.object_id = c.object_id 
        AND c.column_id = sc.column_id
    WHERE
        o.type = 'U'
        AND (s.auto_created = 1 or s.user_created = 1)
    ORDER BY
        schema_name,
        object_name,
        column_name
    ```
    
    <img src = "../assets/images/07_statistics.png"/>

1. Manually create statistics on all the primary key columns by running the cell for **Step 6.2.2** in *WarehouseManagement* notebook. Upon completion, the cell will have a messages output but no query results.

    ``` sql
    CREATE STATISTICS dbo_DimCity_CitySK ON dbo.DimCity (CitySK) WITH FULLSCAN;
    CREATE STATISTICS dbo_DimCustomer_CustomerSK ON dbo.DimCustomer (CustomerSK) WITH FULLSCAN;
    CREATE STATISTICS dbo_DimDate_Date ON dbo.DimDate (Date) WITH FULLSCAN;
    CREATE STATISTICS dbo_DimEmployee_EmployeeSK ON dbo.DimEmployee (EmployeeSK) WITH FULLSCAN;
    CREATE STATISTICS dbo_DimStockItem_StockItemSK ON dbo.DimStockItem (StockItemSK) WITH FULLSCAN;
    ```

    <img src = "../assets/images/07_statistics_created.png"/>

1. See all the stats on the tables again by running the cell for **Step 6.2.3** in *WarehouseManagement* notebook and compare the results to the results from two steps ago, *Step 1*, to see the inclusion of user created stats. 

    ``` sql
    SELECT
        schema_name(o.schema_id) AS schema_name,
        object_name(s.object_id) AS [object_name],
        c.name AS [column_name],
        s.name AS [stats_name],
        STATS_DATE(s.object_id, s.stats_id) AS [stats_update_date], 
        CASE
            WHEN s.auto_created = 1 THEN 'System'
            WHEN s.user_created = 1 THEN 'User'
            ELSE NULL END AS stats_created_by
    FROM sys.stats AS s 
    INNER JOIN sys.objects AS o 
        ON o.object_id = s.object_id 
    LEFT JOIN sys.stats_columns AS sc 
        ON s.object_id = sc.object_id 
        AND s.stats_id = sc.stats_id 
    LEFT JOIN sys.columns AS c 
        ON sc.object_id = c.object_id 
        AND c.column_id = sc.column_id
    WHERE
        o.type = 'U'
        AND (s.auto_created = 1 or s.user_created = 1)
    ORDER BY
        schema_name,
        object_name,
        column_name
    ```

    <img src = "../assets/images/07_statistics_including_user_created.png"/>

<h3 id = "6.3">6.3 - Query monitoring</h3>

Before beginning, open *WarehouseManagement* notebook, navigate to **Lab 6 - Data warehouse management**, and locate the **6.3 - Query monitoring** section.

1. Explore the useful columns available in query insights by running the cell for **Step 6.3.1** in *WarehouseManagement* notebook.

    - distributed_statement_id
    - total_elapsed_time_ms
    - login_name
    - status
    - program_name
    - allocated_cpu_time_ms
    - data_scanned_remote_storage_mb
    - data_scanned_memory_mb
    - data_scanned_disk_mb
    - command

    ```sql
    SELECT TOP 10 * 
    FROM queryinsights.exec_requests_history 
    WHERE
        submit_time > DATEADD(hour, -4, GETDATE()) 
        AND data_scanned_remote_storage_mb + data_scanned_memory_mb + data_scanned_disk_mb > 0
    ORDER BY submit_time DESC
    ```    
    
    <img src = "../assets/images/07_query_insights.png"/>

1. Return to the *Modern Data Warehousing on Microsoft Fabric* workspace created in *Lab 0 - Lab environment setup* by selecting the **workspace icon** from the left navigation bar. 

    *Note: The icons on the navigation bar can be pinned and unpinned. Therefore, the icons you see may differ from the screenshot.*

    <img src = "../assets/images/07_navigation_bar.png" height="450px"/>

1. From the item list, select the **WWI_Gold** warehouse.

    <img src = "../assets/images/07_workspace_warehouse.png"/>

1. From the **Home** tab of the ribbon, select **Query activity** to open the query activity monitor.

    <img src = "../assets/images/07_warehouse_ribbon.png"/>

1. This view shows all completed and currently running queries.  If a query is running and needs to be killed, check the box next to the query then select **Cancel** located above the top left corner of the query list.

    <img src = "../assets/images/07_warehouse_query_activity.png"/>

## Next steps
In this lab you saw how to view important settings for you data warehouse including V-Order, Delta log publishing, and collation. You also checked statistics on tables, and manually created statistics. Finally, you saw a couple of ways to monitor operations on your data warehouse using T-SQL with Query Insights and through the Fabric warehouse UX.

- Continue to [Lab 7- Bonus labs](<07 - Bonus labs.md>)

- Return to the [workshop homepage](<../README.md>)

## Additional Resources
- [Statistics](https://learn.microsoft.com/en-us/fabric/data-warehouse/statistics)
- [V-Order](https://learn.microsoft.com/en-us/fabric/data-warehouse/v-order)
- [Monitor your running and completed T-SQL queries using Query activity](https://learn.microsoft.com/en-us/fabric/data-warehouse/query-activity)
-- [Query insights in Fabric data warehousing](https://learn.microsoft.com/en-us/fabric/data-warehouse/query-insights)
- [Monitor connections, sessions, and requests using DMVs](https://learn.microsoft.com/en-us/fabric/data-warehouse/monitor-using-dmv)
- [Billing and utilization reporting in Fabric Data Warehouse](https://learn.microsoft.com/en-us/fabric/data-warehouse/usage-reporting)
- [Change ownership of Fabric Warehouse](https://learn.microsoft.com/en-us/fabric/data-warehouse/change-ownership)